package com.ussdgateway.service.external;

import com.ussdgateway.domain.enums.AuthenticationType;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;

import java.nio.charset.StandardCharsets;
import java.util.Base64;

@Component
public class AuthenticationHandler {

    /**
     * Applique l'authentification au WebClient selon le type spécifié
     */
    public WebClient.RequestHeadersSpec<?> applyAuthentication(
            WebClient.RequestHeadersSpec<?> request,
            AuthenticationType authenticationType,
            String credentials) {

        return switch (authenticationType) {
            case NONE -> request;
            case BASIC -> applyBasicAuth(request, credentials);
            case BEARER -> applyBearerAuth(request, credentials);
            case API_KEY -> applyApiKeyAuth(request, credentials);
        };
    }

    /**
     * Authentification BASIC (username:password encodé en Base64)
     * Format credentials: "username:password"
     */
    private WebClient.RequestHeadersSpec<?> applyBasicAuth(
            WebClient.RequestHeadersSpec<?> request, String credentials) {
        
        String encodedCredentials = Base64.getEncoder()
            .encodeToString(credentials.getBytes(StandardCharsets.UTF_8));
        
        return request.header("Authorization", "Basic " + encodedCredentials);
    }

    /**
     * Authentification BEARER (token JWT ou OAuth)
     * Format credentials: "your-token-here"
     */
    private WebClient.RequestHeadersSpec<?> applyBearerAuth(
            WebClient.RequestHeadersSpec<?> request, String credentials) {
        
        return request.header("Authorization", "Bearer " + credentials);
    }

    /**
     * Authentification API_KEY
     * Format credentials: "headerName:apiKeyValue" ou juste "apiKeyValue" (défaut: X-API-Key)
     */
    private WebClient.RequestHeadersSpec<?> applyApiKeyAuth(
            WebClient.RequestHeadersSpec<?> request, String credentials) {
        
        String headerName = "X-API-Key";
        String apiKeyValue = credentials;
        
        // Si format "headerName:apiKeyValue"
        if (credentials.contains(":")) {
            String[] parts = credentials.split(":", 2);
            headerName = parts[0];
            apiKeyValue = parts[1];
        }
        
        return request.header(headerName, apiKeyValue);
    }
}