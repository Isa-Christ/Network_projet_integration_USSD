src/main/java/com/network/projet/ussd/
â”‚
â”œâ”€â”€ NetworkProjetUssdApplication.java
â”‚   â””â”€â”€ RÃ´le: Point d'entrÃ©e Spring Boot
â”‚   â””â”€â”€ Appelle: Rien directement
â”‚   â””â”€â”€ MÃ©thodes utiles: main()
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ WebClientConfig.java
â”‚   â”‚   â””â”€â”€ RÃ´le: Configuration du WebClient pour appels API externes
â”‚   â”‚   â””â”€â”€ Appelle: Rien
â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles: webClient() â†’ Bean utilisÃ© par ApiInvoker
â”‚   â”‚
â”‚   â””â”€â”€ R2dbcConfig.java (SI MANQUANT)
â”‚       â””â”€â”€ RÃ´le: Configuration R2DBC pour PostgreSQL rÃ©actif
â”‚       â””â”€â”€ Appelle: Rien
â”‚       â””â”€â”€ MÃ©thodes utiles: connectionFactory()
â”‚
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ UssdController.java ...*
â”‚   â”‚   â””â”€â”€ RÃ´le: Endpoint principal USSD - ReÃ§oit les requÃªtes des opÃ©rateurs
â”‚   â”‚   â””â”€â”€ Appelle: UssdGatewayService, SessionManager
â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles: handleUssd(UssdRequest) â†’ UssdResponse
â”‚   â”‚
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ ServiceAdminController.java
â”‚           â””â”€â”€ RÃ´le: CRUD des services USSD (enregistrement, activation, etc.)
â”‚           â””â”€â”€ Appelle: ServiceAdminService, ServiceRegistry
â”‚           â””â”€â”€ MÃ©thodes utiles: 
â”‚               - registerService(ServiceRegistrationRequest)
â”‚               - listServices()
â”‚               - getService(code)
â”‚               - updateService(code, request)
â”‚               - deleteService(code)
â”‚               - toggleStatus(code)
â”‚
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â”œâ”€â”€ StateType.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Types d'Ã©tats (MENU, INPUT, DISPLAY, PROCESSING, FINAL)
â”‚   â”‚   â”‚   â””â”€â”€ Valeurs: MENU, INPUT, DISPLAY, PROCESSING, FINAL
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ActionType.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Types d'actions (API_CALL, etc.)
â”‚   â”‚   â”‚   â””â”€â”€ Valeurs: API_CALL, STORE_DATA, SEND_SMS
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ AuthenticationType.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Types d'authentification API
â”‚   â”‚   â”‚   â””â”€â”€ Valeurs: NONE, BEARER, API_KEY, BASIC
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ HttpMethod.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: MÃ©thodes HTTP
â”‚   â”‚   â”‚   â””â”€â”€ Valeurs: GET, POST, PUT, PATCH, DELETE
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ValidationType.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Types de validation input
â”‚   â”‚   â”‚   â””â”€â”€ Valeurs: TEXT, NUMERIC, PHONE, EMAIL, ALPHANUMERIC, DECIMAL, NAME
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ValidationErrorCode.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Codes d'erreur de validation
â”‚   â”‚   â”‚   â””â”€â”€ Valeurs: REQUIRED, MIN_LENGTH, MAX_LENGTH, INVALID_FORMAT, etc.
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ApiResponseStatus.java
â”‚   â”‚       â””â”€â”€ RÃ´le: Statuts de rÃ©ponse API externe
â”‚   â”‚       â””â”€â”€ Valeurs: SUCCESS, ERROR, TIMEOUT
â”‚   â”‚
â”‚   â””â”€â”€ model/
â”‚       â”œâ”€â”€ UssdService.java
â”‚       â”‚   â””â”€â”€ RÃ´le: Entity reprÃ©sentant un service USSD en DB
â”‚       â”‚   â””â”€â”€ Table: ussd_service
â”‚       â”‚   â””â”€â”€ Champs: id, code, name, shortCode, jsonConfig, apiBaseUrl, isActive, createdAt, updatedAt
â”‚       â”‚   â””â”€â”€ Appelle: automaton.AutomatonDefinition (Transient)
â”‚       â”‚
â”‚       â”œâ”€â”€ UssdSession.java *
â”‚       â”‚   â””â”€â”€ RÃ´le: Entity reprÃ©sentant une session utilisateur en DB
â”‚       â”‚   â””â”€â”€ Table: ussd_session
â”‚       â”‚   â””â”€â”€ Champs: id, sessionId, phoneNumber, serviceCode, currentStateId, sessionData, createdAt, updatedAt, expiresAt, isActive
â”‚       â”‚
â”‚       â””â”€â”€ automaton/
â”‚           â”œâ”€â”€ AutomatonDefinition.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO racine reprÃ©sentant le JSON workflow complet
â”‚           â”‚   â””â”€â”€ Champs: serviceCode, serviceName, version, shortCode, description, apiConfig, sessionConfig, states
â”‚           â”‚   â””â”€â”€ Appelle: ApiConfig, SessionConfig, State
â”‚           â”‚
â”‚           â”œâ”€â”€ State.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO reprÃ©sentant un Ã©tat de l'automate
â”‚           â”‚   â””â”€â”€ Champs: id, name, type, isInitial, message, storeAs, validation, action, transitions
â”‚           â”‚   â””â”€â”€ Appelle: StateType, ValidationRule, Action, Transition
â”‚           â”‚
â”‚           â”œâ”€â”€ Transition.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO reprÃ©sentant une transition entre Ã©tats
â”‚           â”‚   â””â”€â”€ Champs: input, condition, nextState, value, message
â”‚           â”‚
â”‚           â”œâ”€â”€ Action.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO reprÃ©sentant une action (appel API, etc.)
â”‚           â”‚   â””â”€â”€ Champs: type, method, endpoint, headers, body, onSuccess, onError
â”‚           â”‚   â””â”€â”€ Appelle: ActionType, HttpMethod, ActionResult
â”‚           â”‚
â”‚           â”œâ”€â”€ ActionResult.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO reprÃ©sentant le rÃ©sultat d'une action
â”‚           â”‚   â””â”€â”€ Champs: nextState, responseMapping, message
â”‚           â”‚
â”‚           â”œâ”€â”€ ValidationRule.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO reprÃ©sentant les rÃ¨gles de validation
â”‚           â”‚   â””â”€â”€ Champs: type, minLength, maxLength, pattern, min, max, optional
â”‚           â”‚   â””â”€â”€ Appelle: ValidationType
â”‚           â”‚
â”‚           â”œâ”€â”€ ApiConfig.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO configuration API externe
â”‚           â”‚   â””â”€â”€ Champs: baseUrl, timeout, retryAttempts, authentication
â”‚           â”‚   â””â”€â”€ Appelle: Authentication
â”‚           â”‚
â”‚           â”œâ”€â”€ Authentication.java
â”‚           â”‚   â””â”€â”€ RÃ´le: DTO credentials API
â”‚           â”‚   â””â”€â”€ Champs: type, credentials
â”‚           â”‚   â””â”€â”€ Appelle: AuthenticationType
â”‚           â”‚
â”‚           â””â”€â”€ SessionConfig.java
â”‚               â””â”€â”€ RÃ´le: DTO configuration session
â”‚               â””â”€â”€ Champs: timeoutSeconds, maxInactivitySeconds
â”‚
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”œâ”€â”€ UssdRequest.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: DTO requÃªte USSD entrante
â”‚   â”‚   â”‚   â””â”€â”€ Champs: sessionId, serviceCode, phoneNumber, text
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ServiceRegistrationRequest.java
â”‚   â”‚       â””â”€â”€ RÃ´le: DTO pour enregistrer un service
â”‚   â”‚       â””â”€â”€ Champs: jsonConfig
â”‚   â”‚
â”‚   â”œâ”€â”€ response/
â”‚   â”‚   â”œâ”€â”€ UssdResponse.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: DTO rÃ©ponse USSD sortante
â”‚   â”‚   â”‚   â””â”€â”€ Champs: message, continueSession
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ServiceInfoResponse.java
â”‚   â”‚       â””â”€â”€ RÃ´le: DTO info service pour admin
â”‚   â”‚       â””â”€â”€ Champs: id, code, name, shortCode, apiBaseUrl, isActive, createdAt
â”‚   â”‚
â”‚   â””â”€â”€ ExternalApiResponse.java *
â”‚       â””â”€â”€ RÃ´le: DTO gÃ©nÃ©rique pour rÃ©ponses API externes
â”‚       â””â”€â”€ Champs: status, data, error
â”‚       â””â”€â”€ Appelle: ApiResponseStatus
â”‚
â”œâ”€â”€ exception/
â”‚   â”œâ”€â”€ GlobalExceptionHandler.java
â”‚   â”‚   â””â”€â”€ RÃ´le: Gestionnaire global des exceptions
â”‚   â”‚   â””â”€â”€ Appelle: Toutes les exceptions custom
â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles: handleXxxException() pour chaque type
â”‚   â”‚
â”‚   â”œâ”€â”€ ServiceNotFoundException.java
â”‚   â”‚   â””â”€â”€ RÃ´le: Exception service introuvable
â”‚   â”‚
â”‚   â”œâ”€â”€ SessionExpiredException.java
â”‚   â”‚   â””â”€â”€ RÃ´le: Exception session expirÃ©e
â”‚   â”‚
â”‚   â”œâ”€â”€ InvalidStateException.java
â”‚   â”‚   â””â”€â”€ RÃ´le: Exception Ã©tat invalide/introuvable
â”‚   â”‚
â”‚   â””â”€â”€ ValidationException.java
â”‚       â””â”€â”€ RÃ´le: Exception validation input
â”‚
â”œâ”€â”€ repository/
â”‚   â”œâ”€â”€ UssdServiceRepository.java
â”‚   â”‚   â””â”€â”€ RÃ´le: Repository R2DBC pour UssdService
â”‚   â”‚   â””â”€â”€ Appelle: UssdService
â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚       - findByCode(code) â†’ Mono<UssdService>
â”‚   â”‚       - findByShortCode(shortCode) â†’ Mono<UssdService>
â”‚   â”‚       - findByIsActiveTrue() â†’ Flux<UssdService>
â”‚   â”‚
â”‚   â””â”€â”€ UssdSessionRepository.java *
â”‚       â””â”€â”€ RÃ´le: Repository R2DBC pour UssdSession
â”‚       â””â”€â”€ Appelle: UssdSession
â”‚       â””â”€â”€ MÃ©thodes utiles:
â”‚           - findBySessionId(sessionId) â†’ Mono<UssdSession>
â”‚           - findByPhoneNumber(phoneNumber) â†’ Flux<UssdSession>
â”‚           - deleteByExpiresAtBefore(dateTime) â†’ Mono<Void>
â”‚           - findByIsActiveTrueAndExpiresAtBefore(dateTime) â†’ Flux<UssdSession>
â”‚
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ UssdGatewayService.java *
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Orchestrateur principal du flow USSD
â”‚   â”‚   â”‚   â””â”€â”€ Appelle: SessionManager, ServiceRegistry, AutomatonEngine
â”‚   â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚   â”‚       - processRequest(UssdRequest, UssdSession) â†’ Mono<StateResult>
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ SessionManager.java *
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Gestion des sessions (CRUD + expiration)
â”‚   â”‚   â”‚   â””â”€â”€ Appelle: UssdSessionRepository, ServiceRegistry
â”‚   â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚   â”‚       - getOrCreateSession(sessionId, phoneNumber, serviceCode) â†’ Mono<UssdSession>
â”‚   â”‚   â”‚       - updateSession(session) â†’ Mono<UssdSession>
â”‚   â”‚   â”‚       - storeSessionData(sessionId, key, value) â†’ Mono<Void>
â”‚   â”‚   â”‚       - getSessionData(sessionId) â†’ Mono<Map<String, Object>>
â”‚   â”‚   â”‚       - endSession(sessionId) â†’ Mono<Void>
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ AutomatonEngine.java *
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Moteur d'exÃ©cution de l'automate (transitions)
â”‚   â”‚   â”‚   â””â”€â”€ Appelle: ValidationService, ApiInvoker, TemplateEngine
â”‚   â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚   â”‚       - executeState(automaton, session, userInput) â†’ Mono<StateResult>
â”‚   â”‚   â”‚       - findNextState(state, input, validationResult) â†’ Mono<State>
â”‚   â”‚   â”‚       - processAction(action, session) â†’ Mono<ActionResult>
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ServiceRegistry.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Cache et chargement des automates depuis DB
â”‚   â”‚   â”‚   â””â”€â”€ Appelle: UssdServiceRepository, ObjectMapper
â”‚   â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚   â”‚       - loadAutomaton(serviceCode) â†’ Mono<AutomatonDefinition>
â”‚   â”‚   â”‚       - getServiceByShortCode(shortCode) â†’ Mono<UssdService>
â”‚   â”‚   â”‚       - invalidateCache(serviceCode) â†’ void
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ StateResult.java *
â”‚   â”‚       â””â”€â”€ RÃ´le: DTO rÃ©sultat d'exÃ©cution d'un Ã©tat
â”‚   â”‚       â””â”€â”€ Champs: message, continueSession, nextStateId, updatedSessionData
â”‚   â”‚
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â””â”€â”€ ServiceAdminService.java
â”‚   â”‚       â””â”€â”€ RÃ´le: Logique mÃ©tier admin (enregistrement services)
â”‚   â”‚       â””â”€â”€ Appelle: UssdServiceRepository, ServiceRegistry, ObjectMapper
â”‚   â”‚       â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚           - registerService(jsonConfig) â†’ Mono<UssdService>
â”‚   â”‚           - updateService(code, jsonConfig) â†’ Mono<UssdService>
â”‚   â”‚           - activateService(code) â†’ Mono<UssdService>
â”‚   â”‚           - deactivateService(code) â†’ Mono<UssdService>
â”‚   â”‚           - deleteService(code) â†’ Mono<Void>
â”‚   â”‚
â”‚   â”œâ”€â”€ external/
â”‚   â”‚   â”œâ”€â”€ ApiInvoker.java *
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Invocation des API externes
â”‚   â”‚   â”‚   â””â”€â”€ Appelle: WebClient, AuthenticationHandler, TemplateEngine
â”‚   â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚   â”‚       - invoke(action, apiConfig, sessionData) â†’ Mono<ExternalApiResponse>
â”‚   â”‚   â”‚       - buildRequest(action, sessionData) â†’ WebClient.RequestHeadersSpec
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ AuthenticationHandler.java
â”‚   â”‚   â”‚   â””â”€â”€ RÃ´le: Gestion authentification API (Bearer, API Key, etc.)
â”‚   â”‚   â”‚   â””â”€â”€ Appelle: Rien
â”‚   â”‚   â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚   â”‚       - applyAuthentication(requestSpec, authentication) â†’ WebClient.RequestHeadersSpec
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ SessionExpirationService.java *
â”‚   â”‚       â””â”€â”€ RÃ´le: Cronjob nettoyage sessions expirÃ©es
â”‚   â”‚       â””â”€â”€ Appelle: UssdSessionRepository
â”‚   â”‚       â””â”€â”€ MÃ©thodes utiles:
â”‚   â”‚           - cleanupExpiredSessions() â†’ Mono<Void> (@Scheduled)
â”‚   â”‚
â”‚   â””â”€â”€ validation/
â”‚       â”œâ”€â”€ ValidationService.java
â”‚       â”‚   â””â”€â”€ RÃ´le: Validation des inputs utilisateur
â”‚       â”‚   â””â”€â”€ Appelle: Rien (logique pure)
â”‚       â”‚   â””â”€â”€ MÃ©thodes utiles:
â”‚       â”‚       - validate(input, validationRule) â†’ Mono<ValidationResult>
â”‚       â”‚       - validateText(input, rule) â†’ ValidationResult
â”‚       â”‚       - validateNumeric(input, rule) â†’ ValidationResult
â”‚       â”‚       - validatePhone(input, rule) â†’ ValidationResult
â”‚       â”‚       - validateEmail(input, rule) â†’ ValidationResult
â”‚       â”‚
â”‚       â””â”€â”€ ValidationResult.java ...
â”‚           â””â”€â”€ RÃ´le: DTO rÃ©sultat de validation
â”‚           â””â”€â”€ Champs: isValid, errorCode, errorMessage
â”‚           â””â”€â”€ Appelle: ValidationErrorCode
â”‚
â””â”€â”€ util/
    â”œâ”€â”€ TemplateEngine.java ...
    â”‚   â””â”€â”€ RÃ´le: Remplacement variables {{xxx}} dans messages/API
    â”‚   â””â”€â”€ Appelle: Rien
    â”‚   â””â”€â”€ MÃ©thodes utiles:
    â”‚       - render(template, sessionData) â†’ String
    â”‚       - extractVariables(template) â†’ List<String>
    â”‚
    â”œâ”€â”€ JsonPathExtractor.java
    â”‚   â””â”€â”€ RÃ´le: Extraction donnÃ©es depuis rÃ©ponses API (JSONPath)
    â”‚   â””â”€â”€ Appelle: Rien
    â”‚   â””â”€â”€ MÃ©thodes utiles:
    â”‚       - extract(jsonResponse, path) â†’ Object
    â”‚       - extractMultiple(jsonResponse, mappings) â†’ Map<String, Object>
    â”‚
    â”œâ”€â”€ JsonMapper.java *
    â”‚   â””â”€â”€ RÃ´le: Utilitaires mapping JSON
    â”‚   â””â”€â”€ Appelle: ObjectMapper
    â”‚   â””â”€â”€ MÃ©thodes utiles:
    â”‚       - toJson(object) â†’ String
    â”‚       - fromJson(json, class) â†’ T
    â”‚
    â””â”€â”€ ShortCodeGenerator.java
        â””â”€â”€ RÃ´le: GÃ©nÃ©ration short codes (*500*X#)
        â””â”€â”€ Appelle: UssdServiceRepository
        â””â”€â”€ MÃ©thodes utiles:
            - generateNext() â†’ Mono<String>
            - isAvailable(shortCode) â†’ Mono<Boolean>
            - reserve(shortCode) â†’ Mono<String>












curl -X POST http://localhost:8080/api/admin/services \
  -H "Content-Type: application/json" \
  -d '{
    "jsonConfig": '"$(cat todo-service.json | jq -Rs .)"'
  }'


# ============================================================================
# TEST 1: REQUÃŠTE INITIALE - Utilisateur tape *500#
# ============================================================================

curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "testSession",
    "phoneNumber": "237690123456",
    "ussdCode": "*500*1#",
    "text": ""
  }'

# RÃ©ponse attendue : Le message d'accueil du service (Ã©tat initial)


# ============================================================================
# TEST 2: DEUXIÃˆME INTERACTION - Utilisateur entre "1"
# ============================================================================

# Utilisez le sessionId retournÃ© par la premiÃ¨re requÃªte
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "SESSION_ID_ICI",
    "phoneNumber": "237690123456",
    "serviceCode": "*500#",
    "text": "1",
    "userInput": "1"
  }'


# ============================================================================
# TEST 3: VÃ‰RIFIER LA SESSION EN BASE DE DONNÃ‰ES
# ============================================================================

# Connectez-vous Ã  PostgreSQL
psql -U your_user -d your_database

# VÃ©rifier les sessions actives
SELECT * FROM ussd_sessions WHERE is_active = true ORDER BY created_at DESC;

# VÃ©rifier une session spÃ©cifique par tÃ©lÃ©phone
SELECT * FROM ussd_sessions WHERE phone_number = '237690123456' ORDER BY created_at DESC;

# Voir toutes les sessions
SELECT 
    id,
    session_id,
    phone_number,
    service_code,
    current_state_id,
    is_active,
    created_at,
    expires_at
FROM ussd_sessions 
ORDER BY created_at DESC 
LIMIT 10;


# ============================================================================
# TEST 4: FORMAT AFRICA'S TALKING (si vous utilisez ce gateway)
# ============================================================================

curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "sessionId=&phoneNumber=237690123456&serviceCode=*500*1%23&text="


# ============================================================================
# TEST 5: SCÃ‰NARIO COMPLET - Flow Todo Manager
# ============================================================================

# Ã‰tape 1: Menu principal
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{
    "phoneNumber": "237690123456",
    "serviceCode": "*500#",
    "text": ""
  }' | jq

# RÃ©ponse attendue:
# {
#   "sessionId": "uuid-generated",
#   "message": "Bienvenue sur Todo Manager\n1. CrÃ©er une tÃ¢che\n2. Voir mes tÃ¢ches\n3. Marquer comme terminÃ©",
#   "continueSession": true
# }

# Ã‰tape 2: SÃ©lectionner option 1 (CrÃ©er une tÃ¢che)
SESSION_ID="uuid-from-step-1"
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d "{
    \"sessionId\": \"$SESSION_ID\",
    \"phoneNumber\": \"237690123456\",
    \"serviceCode\": \"*500#\",
    \"text\": \"1\"
  }" | jq

# RÃ©ponse attendue:
# {
#   "sessionId": "same-uuid",
#   "message": "Entrez le titre de la tÃ¢che:",
#   "continueSession": true
# }

# Ã‰tape 3: Entrer le titre
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d "{
    \"sessionId\": \"$SESSION_ID\",
    \"phoneNumber\": \"237690123456\",
    \"serviceCode\": \"*500#\",
    \"text\": \"1*Acheter du lait\"
  }" | jq

# RÃ©ponse attendue:
# {
#   "sessionId": "same-uuid",
#   "message": "TÃ¢che crÃ©Ã©e avec succÃ¨s!",
#   "continueSession": false
# }


# ============================================================================
# TEST 6: TESTER PLUSIEURS UTILISATEURS EN PARALLÃˆLE
# ============================================================================

# Utilisateur 1
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "237690111111", "serviceCode": "*500#", "text": ""}' &

# Utilisateur 2
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "237690222222", "serviceCode": "*500#", "text": ""}' &

# Utilisateur 3
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "237690333333", "serviceCode": "*500#", "text": ""}' &

wait

# VÃ©rifier en base
psql -U your_user -d your_database -c "SELECT phone_number, session_id, is_active FROM ussd_sessions WHERE is_active = true;"


# ============================================================================
# TEST 7: TESTER L'EXPIRATION DE SESSION
# ============================================================================

# CrÃ©er une session
RESPONSE=$(curl -s -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "237690123456", "serviceCode": "*500#", "text": ""}')

SESSION_ID=$(echo $RESPONSE | jq -r '.sessionId')
echo "Session crÃ©Ã©e: $SESSION_ID"

# Attendre 6 minutes (ou votre timeout configurÃ©)
echo "Attente de 6 minutes pour expiration..."
sleep 360

# Essayer d'utiliser la session expirÃ©e
curl -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d "{
    \"sessionId\": \"$SESSION_ID\",
    \"phoneNumber\": \"237690123456\",
    \"serviceCode\": \"*500#\",
    \"text\": \"1\"
  }" | jq

# Devrait crÃ©er une nouvelle session ou retourner une erreur


# ============================================================================
# TEST 8: POSTMAN COLLECTION (Importer dans Postman)
# ============================================================================

cat > ussd_tests.postman_collection.json << 'EOF'
{
  "info": {
    "name": "USSD Gateway Tests",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Initial Request - *500#",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"phoneNumber\": \"237690123456\",\n  \"serviceCode\": \"*500#\",\n  \"text\": \"\"\n}"
        },
        "url": {
          "raw": "http://localhost:8080/api/ussd",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8080",
          "path": ["api", "ussd"]
        }
      }
    },
    {
      "name": "2. Select Option 1",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"sessionId\": \"{{sessionId}}\",\n  \"phoneNumber\": \"237690123456\",\n  \"serviceCode\": \"*500#\",\n  \"text\": \"1\"\n}"
        },
        "url": {
          "raw": "http://localhost:8080/api/ussd",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8080",
          "path": ["api", "ussd"]
        }
      }
    }
  ]
}
EOF

echo "Collection Postman crÃ©Ã©e: ussd_tests.postman_collection.json"


# ============================================================================
# TEST 9: VÃ‰RIFIER LES LOGS
# ============================================================================

# Suivre les logs en temps rÃ©el
tail -f logs/application.log | grep -i "ussd\|session"

# Ou si vous utilisez docker
docker logs -f your-container-name | grep -i "ussd\|session"


# ============================================================================
# TEST 10: SCRIPT DE TEST AUTOMATISÃ‰
# ============================================================================

#!/bin/bash

echo "ðŸš€ DÃ©marrage des tests USSD..."

# Test 1: RequÃªte initiale
echo "ðŸ“± Test 1: RequÃªte initiale *500#"
RESPONSE=$(curl -s -X POST http://localhost:8080/api/ussd \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "237690123456", "serviceCode": "*500#", "text": ""}')

echo "RÃ©ponse: $RESPONSE"

SESSION_ID=$(echo $RESPONSE | jq -r '.sessionId')
MESSAGE=$(echo $RESPONSE | jq -r '.message')

echo "âœ… Session crÃ©Ã©e: $SESSION_ID"
echo "ðŸ“ Message: $MESSAGE"

# VÃ©rifier en base
echo ""
echo "ðŸ” VÃ©rification en base de donnÃ©es..."
psql -U your_user -d your_database -c \
  "SELECT session_id, phone_number, current_state_id, is_active, created_at 
   FROM ussd_sessions 
   WHERE session_id = '$SESSION_ID';"

echo ""
echo "âœ… Tests terminÃ©s!"